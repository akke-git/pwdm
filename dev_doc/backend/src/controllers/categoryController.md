# `backend/src/controllers/categoryController.ts` 코드 설명

이 파일은 `categoryRoutes.ts`에서 정의된 API 엔드포인트 요청을 받아 실제 비즈니스 로직을 수행하고, 그 결과를 클라이언트에게 응답하는 **카테고리 컨트롤러**입니다. Sequelize 모델(`Category`, `PasswordItem`)을 직접 사용하여 데이터베이스와 상호작용하며, 별도의 서비스 계층 없이 컨트롤러 내에서 로직을 처리합니다.

모든 컨트롤러 함수는 `async`로 선언되어 비동기적으로 작동하며, `try...catch` 블록을 사용하여 일반적인 오류 처리를 수행합니다. 성공 시에는 `2xx` 상태 코드와 함께 `success: true` 및 데이터를, 오류 발생 시에는 `4xx` 또는 `500` 상태 코드와 함께 `success: false` 및 오류 메시지를 반환합니다.

---

## 주요 컨트롤러 함수 상세 설명

### 1. `createCategory`

-   **요청**: `POST /categories`
-   **설명**: 새로운 카테고리를 생성합니다.
-   **로직**:
    1.  요청 본문에서 카테고리 이름(`name`), 색상(`color`), 아이콘(`icon`), 설명(`description`)을 추출합니다.
    2.  카테고리 이름은 필수 항목으로 검증합니다.
    3.  현재 사용자가 동일한 이름의 카테고리를 이미 가지고 있는지 확인합니다. (중복 방지 - `Category` 모델의 `unique` 인덱스와 별개로 컨트롤러 레벨에서도 확인)
    4.  중복이 없으면 `Category.create()`를 사용하여 새 카테고리를 데이터베이스에 저장합니다.
    5.  성공 시 `201 Created` 상태와 생성된 카테고리 정보를 반환합니다.

### 2. `getAllCategories`

-   **요청**: `GET /categories`
-   **설명**: 현재 로그인한 사용자의 모든 카테고리 목록을 조회합니다.
-   **로직**:
    1.  `Category.findAll()`을 사용하여 `userId`가 현재 사용자의 ID와 일치하는 모든 카테고리를 조회합니다.
    2.  결과를 카테고리 이름(`name`) 오름차순으로 정렬합니다.
    3.  성공 시 `200 OK` 상태와 카테고리 목록 및 개수를 반환합니다.

### 3. `getCategory`

-   **요청**: `GET /categories/:id`
-   **설명**: 특정 ID를 가진 카테고리의 상세 정보를 조회합니다.
-   **로직**:
    1.  경로 매개변수에서 카테고리 ID(`id`)를 가져옵니다.
    2.  `Category.findOne()`을 사용하여 해당 ID와 `userId`를 만족하는 카테고리를 찾습니다.
    3.  카테고리가 존재하지 않으면 `404 Not Found`를 반환합니다.
    4.  `PasswordItem.count()`를 사용하여 해당 카테고리 이름을 가진 비밀번호 항목의 개수를 조회합니다.
    5.  성공 시 `200 OK` 상태와 카테고리 정보 및 항목 개수를 함께 반환합니다.

### 4. `updateCategory`

-   **요청**: `PUT /categories/:id`
-   **설명**: 특정 카테고리의 정보를 수정합니다.
-   **로직**:
    1.  경로 매개변수에서 카테고리 ID(`id`)와 요청 본문에서 수정할 정보(이름, 색상 등)를 가져옵니다.
    2.  `Category.findOne()`으로 수정할 카테고리를 조회합니다. 없으면 `404 Not Found`.
    3.  만약 카테고리 이름이 변경되는 경우:
        -   변경하려는 새 이름이 현재 사용자에게 이미 존재하는 다른 카테고리 이름과 중복되는지 확인합니다. 중복 시 `409 Conflict`.
        -   `PasswordItem.update()`를 사용하여, 이전 카테고리 이름을 가지고 있던 모든 비밀번호 항목들의 `category` 필드를 새 카테고리 이름으로 업데이트합니다. (데이터 정합성 유지)
    4.  `category.update()`를 사용하여 카테고리 정보를 업데이트합니다.
    5.  성공 시 `200 OK` 상태와 업데이트된 카테고리 정보를 반환합니다.

### 5. `deleteCategory`

-   **요청**: `DELETE /categories/:id`
-   **설명**: 특정 카테고리를 삭제합니다.
-   **로직**:
    1.  경로 매개변수에서 카테고리 ID(`id`)와 쿼리 매개변수 `reassignTo` (선택적: 항목들을 재할당할 다른 카테고리 ID)를 가져옵니다.
    2.  `Category.findOne()`으로 삭제할 카테고리를 조회합니다. 없으면 `404 Not Found`.
    3.  해당 카테고리에 속한 비밀번호 항목들의 처리:
        -   `reassignTo` 값이 제공되면: 해당 ID의 카테고리(`targetCategory`)를 조회하고, `PasswordItem.update()`로 항목들의 `category` 필드를 `targetCategory.name`으로 변경합니다.
        -   `reassignTo` 값이 없으면: `PasswordItem.update()`로 항목들의 `category` 필드를 빈 문자열 (`''`, 미분류)로 변경합니다.
    4.  `category.destroy()`를 사용하여 카테고리를 삭제합니다.
    5.  성공 시 `200 OK` 상태와 성공 메시지를 반환합니다.

### 6. `getCategoryStats`

-   **요청**: `GET /categories/stats`
-   **설명**: 카테고리별 비밀번호 항목 수 통계를 조회합니다.
-   **로직**:
    1.  `Category.findAll()`로 현재 사용자의 모든 카테고리(id, name, color, icon)를 조회합니다.
    2.  `Promise.all`과 `map`을 사용하여 각 카테고리별로 `PasswordItem.count()`를 실행하여 해당 카테고리 이름을 가진 항목 수를 집계합니다.
    3.  `PasswordItem.count()`를 사용하여 카테고리가 빈 문자열(`''`)인 '미분류' 항목 수를 별도로 집계합니다.
    4.  결과 배열에 '미분류' 통계 정보를 추가합니다.
    5.  성공 시 `200 OK` 상태와 통계 데이터를 반환합니다.

---

이 컨트롤러는 카테고리 관리에 필요한 핵심 로직을 직접 구현하고 있으며, 특히 카테고리 이름 변경이나 삭제 시 관련된 비밀번호 항목들의 `category` 필드까지 일관성 있게 업데이트하여 데이터 정합성을 유지하는 점이 중요합니다.
